"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5568],{93594:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>a,contentTitle:()=>n,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var i=t(62540),s=t(43023);const o={description:"The `UserFilter` removal from the Quality Gates is a direct outcome of the removal of the `current_user` predicate from the open source Gerrit.",id:"userfilterremoval",keywords:["git","gerrit","scm","user filter"],lastUpdatedAt:"May 11, 2020",product:"teamforge",tags:["project admin_tasks","project_member_tasks","source_code","git_gerrit","scm"],title:"UserFilter Removal"},n=void 0,l={id:"userfilterremoval",title:"UserFilter Removal",description:"The `UserFilter` removal from the Quality Gates is a direct outcome of the removal of the `current_user` predicate from the open source Gerrit.",source:"@site/versioned_docs/version-23.1/userfilterremoval.md",sourceDirName:".",slug:"/userfilterremoval",permalink:"/docs/userfilterremoval",draft:!1,unlisted:!1,tags:[{inline:!0,label:"project admin_tasks",permalink:"/docs/tags/project-admin-tasks"},{inline:!0,label:"project_member_tasks",permalink:"/docs/tags/project-member-tasks"},{inline:!0,label:"source_code",permalink:"/docs/tags/source-code"},{inline:!0,label:"git_gerrit",permalink:"/docs/tags/git-gerrit"},{inline:!0,label:"scm",permalink:"/docs/tags/scm"}],version:"23.1",lastUpdatedAt:1721042912e3,frontMatter:{description:"The `UserFilter` removal from the Quality Gates is a direct outcome of the removal of the `current_user` predicate from the open source Gerrit.",id:"userfilterremoval",keywords:["git","gerrit","scm","user filter"],lastUpdatedAt:"May 11, 2020",product:"teamforge",tags:["project admin_tasks","project_member_tasks","source_code","git_gerrit","scm"],title:"UserFilter Removal"},sidebar:"docs",previous:{title:"Quality Gates and Review Rules",permalink:"/docs/qualitygates"},next:{title:"Work with the Internal Code Browser",permalink:"/docs/internalcodebrowser"}},a={},c=[{value:"What is a <code>UserFilter</code>?",id:"what-is-a-userfilter",level:2},{value:"What are the reasons to remove <code>UserFilter</code> from the quality gates?",id:"what-are-the-reasons-to-remove-userfilter-from-the-quality-gates",level:2},{value:"Why was the current user predicate removed from open source Gerrit?",id:"why-was-the-current-user-predicate-removed-from-open-source-gerrit",level:2},{value:"How can I check if I am affected by the <code>UserFilter</code> removal?",id:"how-can-i-check-if-i-am-affected-by-the-userfilter-removal",level:2},{value:"How to replace <code>UserFilter</code> from my Quality Gates?",id:"how-to-replace-userfilter-from-my-quality-gates",level:2},{value:"How to verify if you can upgrade to TeamForge\u2014Git integration 20.1 or later?",id:"workflowreadiness",level:2}];function h(e){const r={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(r.h2,{id:"what-is-a-userfilter",children:["What is a ",(0,i.jsx)(r.code,{children:"UserFilter"}),"?"]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"UserFilter"})," is one of building blocks for Quality Gates. It is one of the SubmitRule filters that determines whether a change qualifies for submission or not. SubmitRule with matching filters (or with no filters at all) are evaluated for submission."]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"UserFilter"})," has the following attributes:"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"CurrentUser"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"CurrentUserGroup"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"ignore Author/NonAuthor"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"ignore Committer/NonCommiter"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"ignore Owner/nonOwner"})}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["For example, if you want to disable submit for a user, you can use a ",(0,i.jsx)(r.code,{children:"UserFilter"})," with the ",(0,i.jsx)(r.code,{children:"ignoreAuthor"})," attribute set to ",(0,i.jsx)(r.code,{children:"true"}),". In such a case, the SubmitRule would not be satisfied if the user who is viewing the code review is the author of the latest patch set of that code change. In this case, the code change is not submittable by that user and the Submit button is disabled. This SubmitRule holds good in all other cases."]}),"\n",(0,i.jsxs)(r.h2,{id:"what-are-the-reasons-to-remove-userfilter-from-the-quality-gates",children:["What are the reasons to remove ",(0,i.jsx)(r.code,{children:"UserFilter"})," from the quality gates?"]}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"UserFilter"})," removal is a direct outcome of the removal of the ",(0,i.jsx)(r.a,{href:"https://gerrit-review.googlesource.com/c/gerrit/+/143251",children:"current_user"})," predicate from the open source Gerrit. It is not possible to implement the ",(0,i.jsx)(r.code,{children:"UserFilter"})," without this predicate, as the quality gates would have no information about the current user any longer."]}),"\n",(0,i.jsx)(r.h2,{id:"why-was-the-current-user-predicate-removed-from-open-source-gerrit",children:"Why was the current user predicate removed from open source Gerrit?"}),"\n",(0,i.jsxs)(r.p,{children:["The current user predicate is removed because of the fact that the result of a submittability check should not depend on the user who is asking for it. For more information, ",(0,i.jsx)(r.a,{href:"https://groups.google.com/forum/#!msg/repo-discuss/vW6XhUOkqik/Ea4pco6vlCQJ",children:"click here to follow the discussion on this topic"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["Here are a few arguments that support the ",(0,i.jsx)(r.code,{children:"UserFilter"})," removal:"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Using the current user predicate may produce some surprising results such as two different users being presented with completely different sets of required labels\u2014or even different submit type.  If user A clicks submit, it might be ",(0,i.jsx)(r.strong,{children:"Always Merge"}),", but if user B clicks submit, it might be ",(0,i.jsx)(r.strong,{children:"Cherry-Pick"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Support for the ",(0,i.jsx)(r.code,{children:"is:submittable"})," query. If the ",(0,i.jsx)(r.code,{children:"current_user"})," predicate is used in the prolog rules, the '",(0,i.jsx)(r.code,{children:"submittable"})," field could vary on a user-to-user basis. So, it needs to be re-evaluated for every new request. Re-evaluating this field for every new request is not a good idea as this operation is quite costly."]}),"\n",(0,i.jsxs)(r.li,{children:["You can achieve equivalent results without using the ",(0,i.jsx)(r.code,{children:"current_user"})," predicate."]}),"\n"]}),"\n",(0,i.jsxs)(r.h2,{id:"how-can-i-check-if-i-am-affected-by-the-userfilter-removal",children:["How can I check if I am affected by the ",(0,i.jsx)(r.code,{children:"UserFilter"})," removal?"]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.a,{href:"https://ctf.open.collab.net/sf/go/projects.sfdl/frs.collabnet_teamforge_git_integrat.20_1_workflow_readiness_checker",children:"Use this plugin"})," to check if you are affected."]}),"\n",(0,i.jsxs)(r.h2,{id:"how-to-replace-userfilter-from-my-quality-gates",children:["How to replace ",(0,i.jsx)(r.code,{children:"UserFilter"})," from my Quality Gates?"]}),"\n",(0,i.jsx)(r.p,{children:"Let\u2019s consider the SubmitRule that mandates a user to be both the author and submitter of the change, for example."}),"\n",(0,i.jsx)(r.p,{children:"Here's the SubmitRule rule:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\r\n<cn:GerritWorkflow enableVerification="true" enableCodeReview="true" description="Only the author can submit the change, others can still informally review and verify" name="Author only"  version="1" xsi:schemaLocation="http://www.collab.net/gerritworkflow gerritworkflow.xsd" xmlns:cn="http://www.collab.net/gerritworkflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\r\n\t<cn:SubmitRule displayName="Author-To-Submit" actionIfSatisfied="allow">\r\n\t\t<cn:UserFilter ignoreNonAuthor="true" />\r\n   </cn:SubmitRule>\r\n</cn:GerritWorkflow>\n'})}),"\n",(0,i.jsxs)(r.p,{children:["As you can see, the above rule uses a ",(0,i.jsx)(r.code,{children:"UserFilter"})," with the ",(0,i.jsx)(r.code,{children:"ignoreAuthor"})," attribute. Let's see how to have this done without the ",(0,i.jsx)(r.code,{children:"UserFilter"}),"."]}),"\n",(0,i.jsx)(r.p,{children:"Let's first understand how the above rule works."}),"\n",(0,i.jsx)(r.p,{children:"This rule allows only the author to submit the change. No review is required, so the rule will be submittable for the author but not submittable for anyone else independent from the voting. That means that author is the only one who can decide if the rule can be submitted."}),"\n",(0,i.jsx)(r.p,{children:"You can achieve this by requiring the author to give his approval (Verify +1) to make change submittable:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\r\n<cn:GerritWorkflow enableVerification="true" enableCodeReview="true" description="The change can only be submitted if the author has verified it, others can still informally review and verify" name="Author only" version="1" xsi:schemaLocation="http://www.collab.net/gerritworkflow gerritworkflow.xsd" xmlns:cn="http://www.collab.net/gerritworkflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\r\n\t<cn:SubmitRule displayName="Author-Verify-To-Submit" actionIfSatisfied="allow">\r\n\t\t<cn:VotingCondition value="1" votingCategory="Verified">\r\n\t\t\t<cn:VoteAuthorFilter ignoreAuthorVotes="false" ignoreNonAuthorVotes="true" />\r\n\t\t</cn:VotingCondition>\r\n\t</cn:SubmitRule>\r\n</cn:GerritWorkflow>\n'})}),"\n",(0,i.jsxs)(r.p,{children:["As you can see, the above rule mandates the approval, but the only person whose vote will be considered is the author. So, we now have replaced the ",(0,i.jsx)(r.code,{children:"UserFilter"})," with the ",(0,i.jsx)(r.code,{children:"VotingCondition"})," and ",(0,i.jsx)(r.code,{children:"VoteAuthorFilter"})," attributes. In other words, no one can submit without a vote from the author. Once the author gives a ",(0,i.jsx)(r.code,{children:"Verified +1"})," vote, anyone who has the submit permission can submit the change."]}),"\n",(0,i.jsx)(r.p,{children:"On the other hand, what if you want only a specific person to submit? That\u2019s also possible if you create a special Gerrit group and give only members of this group the right to submit."}),"\n",(0,i.jsx)(r.h2,{id:"workflowreadiness",children:"How to verify if you can upgrade to TeamForge\u2014Git integration 20.1 or later?"}),"\n",(0,i.jsxs)(r.p,{children:["Pre-requisites\r\n: * SSH access to port 29418 of the Gerrit server.\r\n: * User that is a member of the privileged Administrators group. This section uses the admin user for illustrative purposes.\r\n: * The ",(0,i.jsx)(r.code,{children:"plugins.allowRemoteAdmin"}),"\u202foption enabled in\u202fthe ",(0,i.jsx)(r.code,{children:"/opt/collabnet/gerit/etc/gerrit.config"})," file. It is enabled by default. The following error occurs if not: ",(0,i.jsx)(r.code,{children:"Fatal: Remote plugin administration is disabled"}),". If so, you must add the option to the ",(0,i.jsx)(r.code,{children:"gerrit.config"})," file and restart Gerrit."]}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Check your Gerrit version."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"ssh -p 29418 amdin@<gerrit-host> gerrit version \n"})}),"\n",(0,i.jsx)(r.p,{children:"Make sure you are either on Gerrit 2.14 or 2.15."}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.a,{href:"https://ctf.open.collab.net/sf/go/projects.sfdl/frs.collabnet_teamforge_git_integrat.20_1_workflow_readiness_checker",children:"Download"})," the right version of the workflow readiness checker plugin for the version of Gerrit you have (2.14 or 2.15)."]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"(Optional) Verify the list of installed plugins and make sure that the workflow readiness checker plugin is not installed already."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"ssh -p 29418 <gerrit-host> gerrit plugin ls \n"})}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Install the workflow readiness checker plugin. For example, run the following command if you have Gerrit 2.15."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"ssh -p 29418 admin@<gerrit-host> gerrit plugin install -n workflow-checker-2.15.jar - <workflow-checker-2.15.jar \n"})}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Verify the upgrade readiness and fix your setup, if required."}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:["Go to: ",(0,i.jsx)(r.code,{children:"https://<gerrit-host>/gerrit/plugins/workflow-checker/201readiness"})]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Verify if your server is ready for the upgrade."}),"\n",(0,i.jsx)(r.p,{children:"The following message appears if your server is ready for the upgrade."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"Site is\u202fready\u202ffor upgrade to TeamForge 20.1 or higher.\r\nNo usage of the deprecated UserFilter was detected. \n"})}),"\n",(0,i.jsxs)(r.p,{children:["If not, you may see a message that says your site is not ready. For example, the following message appears if the site is not ready for the upgrade.\r\n",(0,i.jsx)(r.img,{src:t(38498).A+"",width:"390",height:"117"})]}),"\n",(0,i.jsxs)(r.p,{children:["If you see a similar message, you must edit the affected xml files and remove the ",(0,i.jsx)(r.code,{children:"UserFilter"})," from them as discussed earlier."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Once you have fixed all the XML files, verify the server readiness again by reloading the workflow readiness checker plugin."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"ssh -p 29418 admin@localhost gerrit plugin reload workflow-checker\n"})}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Once you see the message that says the server is ready for an upgrade, you may uninstall the plugin."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"ssh -p 29418 admin@<gerrit-host> gerrit plugin rm workflow-checker  \n"})}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Verify that the plugin has been uninstalled completely."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"ssh -p 29418 <gerrit-host> gerrit plugin ls \n"})}),"\n",(0,i.jsx)(r.p,{children:"Make sure the workflow-checker plugin is not on the list and you are ready for the upgrade."}),"\n"]}),"\n"]})]})}function d(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},38498:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/201-userfilterremoval-d5fdd7098937219364f64770b598ddfe.png"},43023:(e,r,t)=>{t.d(r,{R:()=>n,x:()=>l});var i=t(63696);const s={},o=i.createContext(s);function n(e){const r=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:n(e.components),i.createElement(o.Provider,{value:r},e.children)}}}]);